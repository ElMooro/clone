<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Intelligence Platform - Enhanced</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    
    <style>
        :root {
            --primary-color: #00dd77;
            --secondary-color: #00aaff;
            --accent-color: #ff6b35;
            --danger-color: #ff4444;
            --warning-color: #ffaa00;
            --success-color: #00dd77;
            --background-dark: #0a0a0a;
            --background-card: #131313;
            --surface-dark: #1a1a1a;
            --surface-light: #252525;
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --border-color: #333;
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.6);
            --glow-primary: 0 0 20px rgba(0, 221, 119, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--background-dark) 0%, #1a1a2e 50%, #16213e 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Enhanced Header */
        .header {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Main Container */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Enhanced Search Section */
        .search-section {
            background: var(--surface-dark);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .search-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
        }

        .search-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 2rem;
        }

        .search-box {
            width: 100%;
            padding: 1rem 3rem 1rem 1.5rem;
            background: var(--background-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: var(--glow-primary), inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .search-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.2rem;
            pointer-events: none;
        }

        /* Enhanced Filter Sections */
        .filter-section {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .filter-toggle {
            background: var(--surface-light);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-toggle:hover {
            background: var(--background-card);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .filter-toggle.active {
            background: var(--primary-color);
            color: var(--background-dark);
            border-color: var(--primary-color);
            box-shadow: var(--glow-primary);
            font-weight: 600;
        }

        .source-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger-color);
            transition: all 0.3s ease;
        }

        .source-indicator.connected {
            background: var(--success-color);
            box-shadow: 0 0 8px var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Search Results */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            margin-top: 8px;
            max-height: 500px;
            overflow-y: auto;
            background: var(--surface-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
        }

        .search-item {
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-item:hover {
            background: var(--background-card);
            transform: translateX(4px);
        }

        .search-item-symbol {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .search-item-name {
            color: var(--text-primary);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .search-item-description {
            color: var(--text-secondary);
            font-size: 0.75rem;
            line-height: 1.4;
        }

        /* Enhanced Navigation Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
            background: var(--surface-dark);
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }

        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            position: relative;
            background: var(--surface-light);
        }

        .tab.active {
            color: var(--primary-color);
            background: var(--surface-dark);
            border-bottom-color: var(--primary-color);
        }

        .tab:hover {
            color: var(--primary-color);
            background: var(--background-card);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Enhanced Cards */
        .card {
            background: var(--surface-dark);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg), 0 0 15px rgba(0, 170, 255, 0.2);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .card-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Enhanced Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--surface-dark);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }

        .metric-card:hover::before {
            transform: translateX(0);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-change {
            font-size: 0.875rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            display: inline-block;
        }

        .metric-change.positive {
            background: rgba(0, 221, 119, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .metric-change.negative {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        .metric-change.neutral {
            background: rgba(170, 170, 170, 0.2);
            color: var(--text-secondary);
            border: 1px solid var(--text-secondary);
        }

        /* Chart Container */
        .chart-container {
            height: 400px;
            width: 100%;
            margin: 1rem 0;
            background: var(--background-card);
            border-radius: 8px;
            padding: 1rem;
        }

        .chart-container.large {
            height: 500px;
        }

        /* Charts Grid for Charts Tab */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(800px, 1fr));
            gap: 2rem;
            width: 100%;
        }

        /* Enhanced Chart Windows */
        .chart-window {
            background: var(--surface-dark);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            min-height: 600px;
            box-shadow: var(--shadow-lg);
            width: 100%;
        }

        .chart-window.active-chart {
            border-color: var(--primary-color);
            box-shadow: var(--glow-primary);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .chart-title-section {
            flex: 1;
            min-width: 300px;
        }

        .chart-title {
            font-size: 1.25rem;
            color: var(--text-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .chart-symbols {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .chart-symbol-tag {
            background: var(--surface-light);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .chart-symbol-tag:hover {
            background: var(--background-card);
            border-color: var(--primary-color);
        }

        .symbol-color-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .remove-symbol {
            cursor: pointer;
            color: var(--danger-color);
            font-weight: bold;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .remove-symbol:hover {
            opacity: 1;
        }

        .chart-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .timeframe-buttons {
            display: flex;
            gap: 2px;
            background: var(--background-card);
            padding: 4px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .timeframe-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            border-radius: 6px;
            font-weight: 500;
        }

        .timeframe-btn:hover {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .timeframe-btn.active {
            background: var(--primary-color);
            color: var(--background-dark);
            font-weight: 600;
        }

        .chart-display-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .display-toggle {
            background: var(--surface-light);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .display-toggle:hover {
            background: var(--background-card);
            border-color: var(--primary-color);
        }

        .display-toggle.active {
            background: var(--primary-color);
            color: var(--background-dark);
            border-color: var(--primary-color);
            font-weight: 600;
        }

        .chart-canvas {
            background: var(--background-card);
            border-radius: 12px;
            height: 500px;
            flex-grow: 1;
            min-height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-message {
            color: var(--text-secondary);
            font-size: 1rem;
            text-align: center;
            padding: 2rem;
        }

        /* Enhanced Watchlist */
        .watchlist {
            background: var(--surface-dark);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .watchlist-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--background-dark);
            padding: 1.5rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .watchlist-controls {
            display: flex;
            gap: 0.5rem;
        }

        .watchlist-selector {
            background: rgba(0, 0, 0, 0.2);
            color: var(--background-dark);
            border: 1px solid rgba(0, 0, 0, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 600;
        }

        .watchlist-content {
            max-height: 600px;
            overflow-y: auto;
        }

        .watchlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .watchlist-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary-color);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .watchlist-item:hover::before {
            transform: scaleY(1);
        }

        .watchlist-item:hover {
            background: var(--background-card);
            transform: translateX(4px);
        }

        .watchlist-item:last-child {
            border-bottom: none;
        }

        .watchlist-symbol {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .watchlist-value {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .watchlist-change {
            font-size: 0.875rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-weight: 600;
        }

        .positive {
            color: var(--success-color);
        }

        .negative {
            color: var(--danger-color);
        }

        .neutral {
            color: var(--text-secondary);
        }

        /* Enhanced Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #00bb66);
            color: var(--background-dark);
            box-shadow: 0 4px 15px rgba(0, 221, 119, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 221, 119, 0.4);
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--background-card);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #cc3333);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 68, 68, 0.4);
        }

        .close-btn {
            background: var(--danger-color);
            color: white;
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #ff6666;
            transform: scale(1.1);
        }

        /* Status and Alerts */
        .liquidity-alert {
            background: linear-gradient(135deg, var(--danger-color), #ff6666);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            animation: pulse 2s infinite;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .liquidity-alert:hover {
            transform: scale(1.05);
        }

        .liquidity-alert.moderate {
            background: linear-gradient(135deg, var(--warning-color), #ffcc00);
            color: var(--background-dark);
        }

        .liquidity-alert.low {
            background: linear-gradient(135deg, var(--success-color), #00ff88);
            color: var(--background-dark);
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--danger-color);
            transition: all 0.3s ease;
        }

        .status-dot.connected {
            background: var(--success-color);
            box-shadow: 0 0 10px var(--success-color);
        }

        /* Loading States */
        .loading-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Message Popup */
        .message-popup {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--surface-dark);
            border: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            z-index: 2000;
            animation: slideInAndOut 4s ease-in-out forwards;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            max-width: 400px;
        }

        .message-popup.info {
            border-left: 4px solid var(--primary-color);
        }

        .message-popup.error {
            border-left: 4px solid var(--danger-color);
            color: var(--danger-color);
        }

        .message-popup.success {
            border-left: 4px solid var(--success-color);
            color: var(--success-color);
        }

        @keyframes slideInAndOut {
            0% { transform: translateX(120%); opacity: 0; }
            15%, 85% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(120%); opacity: 0; }
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: -1;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 1rem;
            }
            
            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .chart-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-dark);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        /* Clock Style */
        #clock {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-family: 'Courier New', monospace;
            padding: 0.5rem 1rem;
            background: var(--surface-dark);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        /* No Data State */
        .no-data {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .no-data h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            📊 FINANCIAL INTELLIGENCE PLATFORM
        </div>
        <div class="header-controls">
            <div class="liquidity-alert" id="liquidityAlert" onclick="showLiquidityDashboard()" style="display: none;">
                <span id="liquidityAlertText">Checking Liquidity...</span>
            </div>
            <div class="api-status">
                <div class="status-dot" id="apiStatus"></div>
                <span id="apiStatusText">7/7 APIs Connected</span>
            </div>
            <button class="btn btn-primary" onclick="addNewChart()">+ New Chart</button>
            <span id="clock">11:54:05</span>
        </div>
    </header>

    <div class="container">
        <div class="search-section">
            <div class="search-container">
                <input type="text" class="search-box" id="searchBox"
                       placeholder="Search all financial instruments (Stocks, ETFs, Crypto, Bonds, Indices, Economic Data)..."
                       onkeyup="performSearch(this.value)"
                       autocomplete="off">
                <span class="search-icon">🔍</span>
                <div class="search-results" id="searchResults" style="display: none;"></div>
            </div>
            
            <div class="filter-section">
                <button class="filter-toggle active" data-type="CS" onclick="toggleTickerType('CS')">📈 Stocks</button>
                <button class="filter-toggle active" data-type="ETF" onclick="toggleTickerType('ETF')">🎯 ETFs</button>
                <button class="filter-toggle active" data-type="CRYPTO" onclick="toggleTickerType('CRYPTO')">₿ Crypto</button>
                <button class="filter-toggle active" data-type="MF" onclick="toggleTickerType('MF')">🏛️ Mutual Funds</button>
                <button class="filter-toggle active" data-type="BOND" onclick="toggleTickerType('BOND')">🏦 Bonds</button>
                <button class="filter-toggle active" data-type="INDEX" onclick="toggleTickerType('INDEX')">📊 Indices</button>
                <button class="filter-toggle active" data-type="OTHER" onclick="toggleTickerType('OTHER')">🔧 Other</button>
            </div>
            
            <div class="filter-section">
                <button class="filter-toggle active" data-source="polygon" onclick="toggleDataSource('polygon')">
                    <span class="source-indicator connected" id="polygon-indicator"></span>
                    Polygon
                </button>
                <button class="filter-toggle active" data-source="fred" onclick="toggleDataSource('fred')">
                    <span class="source-indicator connected" id="fred-indicator"></span>
                    FRED
                </button>
                <button class="filter-toggle active" data-source="ny_fed" onclick="toggleDataSource('ny_fed')">
                    <span class="source-indicator connected" id="ny_fed-indicator"></span>
                    NY Fed
                </button>
                <button class="filter-toggle active" data-source="ecb" onclick="toggleDataSource('ecb')">
                    <span class="source-indicator connected" id="ecb-indicator"></span>
                    ECB
                </button>
                <button class="filter-toggle active" data-source="ofr" onclick="toggleDataSource('ofr')">
                    <span class="source-indicator connected" id="ofr-indicator"></span>
                    OFR
                </button>
                <button class="filter-toggle active" data-source="treasury" onclick="toggleDataSource('treasury')">
                    <span class="source-indicator connected" id="treasury-indicator"></span>
                    Treasury
                </button>
                <button class="filter-toggle active" data-source="liquidity" onclick="toggleDataSource('liquidity')">
                    <span class="source-indicator connected" id="liquidity-indicator"></span>
                    Liquidity Intelligence
                </button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('overview')">📊 Overview</div>
            <div class="tab" onclick="showTab('charts')">📈 Charts</div>
            <div class="tab" onclick="showTab('risk')">⚠️ Risk Analysis</div>
            <div class="tab" onclick="showTab('liquidity')">💧 Liquidity</div>
            <div class="tab" onclick="showTab('settings')">⚙️ Settings</div>
        </div>

        <div id="overview" class="tab-content active">
            <div class="metrics-grid" id="keyMetrics">
                <div class="metric-card">
                    <div class="metric-value">5.33%</div>
                    <div class="metric-label">Fed Funds Rate</div>
                    <div class="metric-change positive">+0.05%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">3.9%</div>
                    <div class="metric-label">Unemployment</div>
                    <div class="metric-change negative">-0.1%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">18.5</div>
                    <div class="metric-label">VIX</div>
                    <div class="metric-change positive">+2.1%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">4.50%</div>
                    <div class="metric-label">ECB Rate</div>
                    <div class="metric-change neutral">0.00%</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="main-content">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Market Overview</h3>
                                <p class="card-subtitle">Real-time economic indicators</p>
                            </div>
                        </div>
                        <div class="chart-container" id="marketOverviewChart"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">AI Market Predictions</h3>
                                <p class="card-subtitle">Machine learning insights</p>
                            </div>
                        </div>
                        <div id="aiPredictions">
                            <div class="metrics-grid" style="margin-bottom: 0;">
                                <div class="metric-card">
                                    <div class="metric-label">BITCOIN</div>
                                    <div class="metric-value" style="color: var(--warning-color)">NEUTRAL</div>
                                    <div class="metric-change neutral">Confidence: 60%</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                        Mixed macro environment
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">LIQUIDITY</div>
                                    <div class="metric-value" style="color: var(--warning-color)">MODERATE RISK</div>
                                    <div class="metric-change neutral">Confidence: 70%</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                        Central bank policy tightening
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ETF</div>
                                    <div class="metric-value" style="color: var(--warning-color)">NEUTRAL</div>
                                    <div class="metric-change neutral">Confidence: 60%</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                        Balanced market conditions
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sidebar">
                    <div class="watchlist">
                        <div class="watchlist-header">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span>Watchlist</span>
                                <select class="watchlist-selector" id="watchlistSelector" onchange="switchWatchlist(this.value)">
                                    <option value="MAIN">MAIN</option>
                                    <option value="STOCKS">STOCKS</option>
                                    <option value="NY FED RATES">NY FED RATES</option>
                                    <option value="ECB SYSTEMIC STRESS">ECB SYSTEMIC STRESS</option>
                                    <option value="ECONOMIC INDICATORS">ECONOMIC INDICATORS</option>
                                </select>
                            </div>
                            <div class="watchlist-controls">
                                <button class="btn btn-secondary" onclick="showSearchModal()" style="padding: 0.5rem; font-size: 0.875rem;">🔍</button>
                                <button class="btn btn-secondary" onclick="showTab('risk')" style="padding: 0.5rem; font-size: 0.875rem;">📊</button>
                                <button class="btn btn-primary" onclick="addNewChart()" style="padding: 0.5rem; font-size: 0.875rem;">📈</button>
                            </div>
                        </div>
                        
                        <div class="watchlist-content" id="watchlistItems">
                            <div class="watchlist-item" ondblclick="openChartForSymbol('AAPL', 'polygon_direct')">
                                <div>
                                    <div class="watchlist-symbol">AAPL</div>
                                    <div class="watchlist-value">POLYGON • $220.50</div>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                                    <div class="watchlist-change positive">+2.15%</div>
                                    <button onclick="removeFromWatchlist('AAPL')" class="btn-danger">×</button>
                                </div>
                            </div>
                            <div class="watchlist-item" ondblclick="openChartForSymbol('FEDFUNDS', 'fred_direct')">
                                <div>
                                    <div class="watchlist-symbol">FEDFUNDS</div>
                                    <div class="watchlist-value">FRED • 5.33</div>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                                    <div class="watchlist-change positive">+0.05%</div>
                                    <button onclick="removeFromWatchlist('FEDFUNDS')" class="btn-danger">×</button>
                                </div>
                            </div>
                            <div class="watchlist-item" ondblclick="openChartForSymbol('UNRATE', 'fred_direct')">
                                <div>
                                    <div class="watchlist-symbol">UNRATE</div>
                                    <div class="watchlist-value">FRED • 3.90</div>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                                    <div class="watchlist-change negative">-0.10%</div>
                                    <button onclick="removeFromWatchlist('UNRATE')" class="btn-danger">×</button>
                                </div>
                            </div>
                            <div class="watchlist-item" ondblclick="openChartForSymbol('sofr', 'ny_fed_direct')">
                                <div>
                                    <div class="watchlist-symbol">sofr</div>
                                    <div class="watchlist-value">NY FED • 5.32</div>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                                    <div class="watchlist-change neutral">+0.01%</div>
                                    <button onclick="removeFromWatchlist('sofr')" class="btn-danger">×</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Market Status</h4>
                        </div>
                        <div id="marketStatus">
                            <div class="metrics-grid" style="margin-bottom: 0;">
                                <div class="metric-card">
                                    <div class="metric-label">Market Sentiment</div>
                                    <div class="metric-value" style="color: var(--success-color)">Bullish</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">Risk Level</div>
                                    <div class="metric-value" style="color: var(--warning-color)">Medium</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">Liquidity</div>
                                    <div class="metric-value" style="color: var(--success-color)">Normal</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="charts" class="tab-content">
            <div class="chart-grid" id="chartGrid">
                <div class="no-data">
                    <h3>No Charts Created</h3>
                    <p>Click "+ New Chart" to create your first chart, or double-click any item in the watchlist.</p>
                    <button class="btn btn-primary" onclick="addNewChart()" style="margin-top: 1rem;">+ Create Chart</button>
                </div>
            </div>
        </div>

        <div id="risk" class="tab-content">
            <div class="no-data">
                <h3>Risk Dashboard</h3>
                <p>Advanced risk analysis tools are being loaded...</p>
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div id="liquidity" class="tab-content">
            <div class="no-data">
                <h3>Liquidity Analysis</h3>
                <p>Liquidity intelligence dashboard is being prepared...</p>
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Dashboard Settings</h3>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="font-weight: 600; color: var(--text-primary);">Refresh Interval</label>
                        <select id="refreshInterval" style="background: var(--surface-light); border: 1px solid var(--border-color); color: var(--text-primary); padding: 0.75rem; border-radius: 8px;">
                            <option value="30">30 seconds</option>
                            <option value="60" selected>1 minute</option>
                            <option value="300">5 minutes</option>
                            <option value="900">15 minutes</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="font-weight: 600; color: var(--text-primary);">Default Time Range</label>
                        <select id="defaultTimeRange" style="background: var(--surface-light); border: 1px solid var(--border-color); color: var(--text-primary); padding: 0.75rem; border-radius: 8px;">
                            <option value="1D">1 Day</option>
                            <option value="1W">1 Week</option>
                            <option value="1M" selected>1 Month</option>
                            <option value="3M">3 Months</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                        <button class="btn btn-secondary" onclick="refreshAllData()">Refresh All Data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'https://ped8gafyuz.us-east-1.awsapprunner.com';
        
        // Enhanced watchlists with proper structure
        const watchlists = {
            'MAIN': {
                symbols: [
                    { symbol: 'AAPL', provider: 'polygon_direct', name: 'Apple Inc.' },
                    { symbol: 'FEDFUNDS', provider: 'fred_direct', name: 'Federal Funds Rate' },
                    { symbol: 'UNRATE', provider: 'fred_direct', name: 'Unemployment Rate' },
                    { symbol: 'sofr', provider: 'ny_fed_direct', name: 'Secured Overnight Financing Rate' }
                ]
            },
            'STOCKS': {
                symbols: [
                    { symbol: 'AAPL', provider: 'polygon_direct', name: 'Apple Inc.' },
                    { symbol: 'MSFT', provider: 'polygon_direct', name: 'Microsoft Corporation' },
                    { symbol: 'GOOGL', provider: 'polygon_direct', name: 'Alphabet Inc.' },
                    { symbol: 'AMZN', provider: 'polygon_direct', name: 'Amazon.com Inc.' },
                    { symbol: 'TSLA', provider: 'polygon_direct', name: 'Tesla Inc.' }
                ]
            },
            'NY FED RATES': {
                symbols: [
                    { symbol: 'sofr', provider: 'ny_fed_direct', name: 'Secured Overnight Financing Rate' },
                    { symbol: 'effr', provider: 'ny_fed_direct', name: 'Effective Federal Funds Rate' },
                    { symbol: 'obfr', provider: 'ny_fed_direct', name: 'Overnight Bank Funding Rate' }
                ]
            },
            'ECB SYSTEMIC STRESS': {
                symbols: [
                    { symbol: 'CISS.D.U2.Z0Z.4F.EC.SS_CIN.IDX', provider: 'ecb_direct', name: 'Euro Area Systemic Stress Index' },
                    { symbol: 'CISS.D.US.Z0Z.4F.EC.SS_CI.IDX', provider: 'ecb_direct', name: 'US Daily Systemic Stress Index' }
                ]
            },
            'ECONOMIC INDICATORS': {
                symbols: [
                    { symbol: 'GDP', provider: 'fred_direct', name: 'Gross Domestic Product' },
                    { symbol: 'CPIAUCSL', provider: 'fred_direct', name: 'Consumer Price Index' },
                    { symbol: 'PAYEMS', provider: 'fred_direct', name: 'Total Nonfarm Payrolls' }
                ]
            }
        };

        // Global variables
        let currentWatchlist = 'MAIN';
        let watchlistData = {};
        let charts = {};
        let chartIdCounter = 0;
        let activeChartId = null;
        let searchTimeout = null;
        const colorPalette = ['#00AEEF', '#FF4444', '#F4D03F', '#58D68D', '#FF7043'];

        // Initialize the dashboard
        function init() {
            console.log('🚀 Initializing Financial Intelligence Dashboard');
            updateClock();
            setInterval(updateClock, 1000);
            
            // Initialize market overview chart
            initializeMarketOverviewChart();
            
            // Load watchlist data
            loadWatchlistData();
            
            // Show initial data
            updateKeyMetrics();
        }

        // Initialize market overview chart
        function initializeMarketOverviewChart() {
            const trace = {
                x: ['2024-06', '2024-07', '2024-08', '2024-09', '2024-10', '2024-11'],
                y: [5.2, 5.1, 4.9, 4.8, 4.7, 4.6],
                type: 'scatter',
                mode: 'lines',
                name: 'Fed Funds Rate',
                line: { color: '#00dd77', width: 3 }
            };
            
            const layout = {
                title: 'Key Economic Indicators',
                xaxis: { 
                    title: 'Date',
                    gridcolor: '#333',
                    tickfont: { color: '#aaa' }
                },
                yaxis: { 
                    title: 'Rate (%)',
                    gridcolor: '#333',
                    tickfont: { color: '#aaa' }
                },
                margin: { t: 40, r: 20, b: 40, l: 60 },
                showlegend: false,
                plot_bgcolor: '#131313',
                paper_bgcolor: '#131313',
                font: { color: '#e0e0e0' }
            };
            
            Plotly.newPlot('marketOverviewChart', [trace], layout, { responsive: true, displayModeBar: false });
        }

        // Load watchlist data (mock for now)
        function loadWatchlistData() {
            const currentSymbols = watchlists[currentWatchlist].symbols;
            
            currentSymbols.forEach(item => {
                // Mock data for demonstration
                watchlistData[item.symbol] = {
                    name: item.name,
                    provider: item.provider,
                    price: Math.random() * 200 + 50,
                    change: (Math.random() - 0.5) * 10
                };
            });
            
            updateWatchlist();
        }

        // Update watchlist display
        function updateWatchlist() {
            const container = document.getElementById('watchlistItems');
            const items = watchlists[currentWatchlist].symbols;
            
            if (items.length === 0) {
                container.innerHTML = '<div class="no-data"><p>No items in this watchlist</p></div>';
                return;
            }
            
            container.innerHTML = items.map(item => {
                const data = watchlistData[item.symbol] || {};
                const changeClass = data.change > 0 ? 'positive' : data.change < 0 ? 'negative' : 'neutral';
                const changeText = data.change ? `${data.change > 0 ? '+' : ''}${data.change.toFixed(2)}%` : '+0.00%';
                const price = data.price ? data.price.toFixed(2) : '0.00';
                const source = (item.provider || 'API').replace('_direct', '').toUpperCase();
                
                return `
                    <div class="watchlist-item" ondblclick="openChartForSymbol('${item.symbol}', '${item.provider}')">
                        <div>
                            <div class="watchlist-symbol">${item.symbol}</div>
                            <div class="watchlist-value">${source} • ${price}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                            <div class="watchlist-change ${changeClass}">${changeText}</div>
                            <button onclick="removeFromWatchlist('${item.symbol}')" class="btn-danger">×</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Switch watchlist
        function switchWatchlist(watchlistName) {
            currentWatchlist = watchlistName;
            loadWatchlistData();
        }

        // Remove from watchlist
        function removeFromWatchlist(symbol) {
            event.stopPropagation(); // Important to prevent double click from firing on the parent
            const currentSymbols = watchlists[currentWatchlist].symbols;
            const index = currentSymbols.findIndex(s => s.symbol === symbol);
            if (index > -1) {
                currentSymbols.splice(index, 1);
                delete watchlistData[symbol]; // Also remove from cached data
                updateWatchlist();
                showTemporaryMessage(`Removed ${symbol} from watchlist`, 'success');
            }
        }

        // Chart Functions
        function addNewChart() {
            const chartId = `chart_${chartIdCounter++}`;
            const chartGrid = document.getElementById('chartGrid');
            
            // Remove no-data message if it exists
            const noData = chartGrid.querySelector('.no-data');
            if (noData) {
                noData.remove();
            }
            
            const chartHtml = `
                <div class="chart-window" id="${chartId}" onclick="setActiveChart('${chartId}')">
                    <div class="chart-header">
                        <div class="chart-title-section">
                            <div class="chart-title" id="${chartId}_title">Chart ${chartIdCounter}</div>
                            <div class="chart-symbols" id="${chartId}_symbols"></div>
                            <div class="chart-display-controls">
                                <button class="display-toggle active" onclick="toggleChartDisplay(event, '${chartId}', 'raw')">Raw Data</button>
                                <button class="display-toggle" onclick="toggleChartDisplay(event, '${chartId}', 'pct_change')">% Change</button>
                                <button class="display-toggle" onclick="toggleChartDisplay(event, '${chartId}', 'macd')">MACD</button>
                            </div>
                        </div>
                        <div class="chart-controls">
                            <div class="timeframe-buttons">
                                ${['1D','1W','1M','3M','6M','1Y','2Y','5Y','MAX'].map(tf =>
                                    `<button class="timeframe-btn ${tf === '1Y' ? 'active' : ''}"
                                             onclick="changeTimeframe(event, '${chartId}', '${tf}')">${tf}</button>`
                                ).join('')}
                            </div>
                            <button class="close-btn" onclick="removeChart(event, '${chartId}')">×</button>
                        </div>
                    </div>
                    <div class="chart-canvas" id="${chartId}_canvas">
                        <div class="chart-message">Search for a financial indicator to add to this chart</div>
                    </div>
                </div>`;
            
            chartGrid.insertAdjacentHTML('beforeend', chartHtml);
            charts[chartId] = {
                symbols: [],
                data: {},
                timeframe: '1Y',
                displayMode: 'raw' // Default display mode
            };
            setActiveChart(chartId);
            
            // Show charts tab
            showTab('charts');
        }

        function setActiveChart(chartId) {
            activeChartId = chartId;
            document.querySelectorAll('.chart-window').forEach(c => c.classList.remove('active-chart'));
            const chartElement = document.getElementById(chartId);
            if (chartElement) {
                chartElement.classList.add('active-chart');
            }
        }

        function removeChart(event, chartId) {
            event.stopPropagation(); // Prevent click on parent chart window
            delete charts[chartId];
            document.getElementById(chartId)?.remove();
            
            // Show no-data message if no charts left
            if (Object.keys(charts).length === 0) {
                const chartGrid = document.getElementById('chartGrid');
                chartGrid.innerHTML = `
                    <div class="no-data">
                        <h3>No Charts Created</h3>
                        <p>Click "+ New Chart" to create your first chart, or double-click any item in the watchlist.</p>
                        <button class="btn btn-primary" onclick="addNewChart()" style="margin-top: 1rem;">+ Create Chart</button>
                    </div>
                `;
            }
        }

        function openChartForSymbol(symbol, provider) {
            if (Object.keys(charts).length === 0) {
                addNewChart(); // Create a new chart if none exist
            }
            
            if (activeChartId) {
                addToChart(activeChartId, symbol, provider);
            } else {
                // If no chart is active (e.g., after deleting all charts), create a new one and add.
                addNewChart();
                // Need a slight delay for the new chart to be fully added to the DOM and activeChartId to be set.
                setTimeout(() => {
                    if (activeChartId) { // Check again if activeChartId is set
                         addToChart(activeChartId, symbol, provider);
                    }
                }, 100); // 100ms should be enough
            }
        }

        function addToChart(chartId, symbol, provider) {
            const chart = charts[chartId];
            if (!chart) return;
            
            // Check if symbol already exists in this chart
            if (!chart.symbols.find(s => s.symbol === symbol)) {
                const symbolData = watchlistData[symbol] || { name: symbol }; // Get name from watchlistData or use symbol as name
                chart.symbols.push({ symbol, provider, name: symbolData.name });
                
                // Generate mock historical data for demonstration
                const dates = [];
                const values = [];
                const baseValue = symbolData.price || 100; // Use watchlist price or default
                
                for (let i = 365; i >= 0; i--) { // Generate 1 year of daily data
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    dates.push(date.toISOString().split('T')[0]);
                    // Simulate some price movement
                    values.push(baseValue + (Math.random() - 0.5) * 20 + Math.sin(i * 0.1) * 10);
                }
                
                chart.data[symbol] = { dates, values };
                updateChartRender(chartId); // This function needs to be implemented
                updateChartSymbols(chartId); // This function needs to be implemented
            } // <-- This was the missing closing brace
        }

        // --- Placeholder functions that need implementation ---
        function updateKeyMetrics() {
            console.log("Updating key metrics...");
            // In a real app, fetch and update #keyMetrics content
        }

        function updateClock() {
            document.getElementById('clock').textContent = moment().format('HH:mm:ss');
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
            console.log(`Switched to tab: ${tabName}`);
        }

        function performSearch(query) {
            clearTimeout(searchTimeout);
            const searchResultsEl = document.getElementById('searchResults');
            if (query.length < 2) {
                searchResultsEl.style.display = 'none';
                return;
            }
            searchTimeout = setTimeout(async () => {
                console.log(`Searching for: ${query}`);
                // Mock search results
                const mockResults = [
                    { symbol: 'AAPL', name: 'Apple Inc.', description: 'Technology company', provider: 'polygon_direct' },
                    { symbol: 'TSLA', name: 'Tesla Inc.', description: 'Electric vehicles', provider: 'polygon_direct' },
                    { symbol: 'BTCUSD', name: 'Bitcoin USD', description: 'Cryptocurrency', provider: 'polygon_direct' },
                    { symbol: 'FEDFUNDS', name: 'Federal Funds Rate', description: 'Economic Indicator', provider: 'fred_direct' }
                ].filter(item => item.symbol.toLowerCase().includes(query.toLowerCase()) || item.name.toLowerCase().includes(query.toLowerCase()));

                if (mockResults.length > 0) {
                    searchResultsEl.innerHTML = mockResults.map(item => `
                        <div class="search-item" onclick="addFromSearch('${item.symbol}', '${item.provider}', '${item.name.replace(/'/g, "\\'")}')">
                            <div>
                                <div class="search-item-symbol">${item.symbol}</div>
                                <div class="search-item-name">${item.name}</div>
                                <div class="search-item-description">${item.description}</div>
                            </div>
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem;">Add</button>
                        </div>
                    `).join('');
                    searchResultsEl.style.display = 'block';
                } else {
                    searchResultsEl.innerHTML = '<div class="search-item"><p>No results found.</p></div>';
                    searchResultsEl.style.display = 'block';
                }
            }, 300);
        }
        
        function addFromSearch(symbol, provider, name) {
            console.log(`Adding ${symbol} from search to active chart or watchlist.`);
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchBox').value = '';

            if (activeChartId && charts[activeChartId]) {
                 // Ensure watchlistData has the item if it's new, for name consistency
                if (!watchlistData[symbol]) {
                    watchlistData[symbol] = { name: name, provider: provider, price: Math.random() * 100, change: 0 }; // Add mock data
                }
                addToChart(activeChartId, symbol, provider);
                showTemporaryMessage(`Added ${symbol} to chart ${activeChartId}`, 'success');
            } else {
                 // Add to current watchlist if no chart is active or if charts tab is not active
                if (!watchlists[currentWatchlist].symbols.find(s => s.symbol === symbol)) {
                    watchlists[currentWatchlist].symbols.push({ symbol, provider, name });
                    if (!watchlistData[symbol]) {
                         watchlistData[symbol] = { name: name, provider: provider, price: Math.random() * 100 + 50, change: (Math.random() -0.5) * 5 };
                    }
                    updateWatchlist();
                    showTemporaryMessage(`Added ${symbol} to ${currentWatchlist} watchlist`, 'success');
                } else {
                    showTemporaryMessage(`${symbol} is already in the ${currentWatchlist} watchlist`, 'info');
                }
            }
        }


        function updateChartRender(chartId) {
            const chart = charts[chartId];
            const canvas = document.getElementById(`${chartId}_canvas`);
            if (!chart || chart.symbols.length === 0) {
                canvas.innerHTML = '<div class="chart-message">Search for a financial indicator to add to this chart</div>';
                Plotly.purge(canvas); // Clear any existing plot
                return;
            }

            const traces = chart.symbols.map((s, index) => {
                const symbolData = chart.data[s.symbol];
                if (!symbolData) return null; // Should not happen if data is loaded correctly

                let yValues = symbolData.values;
                let yAxisTitle = 'Value';

                if (chart.displayMode === 'pct_change') {
                    const firstValue = symbolData.values[0];
                    yValues = symbolData.values.map(v => ((v - firstValue) / firstValue) * 100);
                    yAxisTitle = '% Change';
                }
                // Add MACD or other indicators here if needed

                return {
                    x: symbolData.dates,
                    y: yValues,
                    type: 'scatter',
                    mode: 'lines',
                    name: s.symbol,
                    line: { color: colorPalette[index % colorPalette.length], width: 2 }
                };
            }).filter(t => t !== null);

            if (traces.length === 0) {
                 canvas.innerHTML = '<div class="chart-message">No data to display for selected symbols.</div>';
                 Plotly.purge(canvas);
                 return;
            }
            
            const layout = {
                xaxis: { gridcolor: '#333', tickfont: { color: '#aaa' } },
                yaxis: { title: yAxisTitle, gridcolor: '#333', tickfont: { color: '#aaa' } },
                margin: { t: 20, r: 20, b: 40, l: 60 },
                showlegend: true,
                legend: { font: { color: '#e0e0e0'} },
                plot_bgcolor: '#131313', // Match card background
                paper_bgcolor: '#131313', // Match card background
                font: { color: '#e0e0e0' }
            };

            Plotly.react(`${chartId}_canvas`, traces, layout, { responsive: true, displayModeBar: false });
        }

        function updateChartSymbols(chartId) {
            const chart = charts[chartId];
            const symbolsContainer = document.getElementById(`${chartId}_symbols`);
            const chartTitleEl = document.getElementById(`${chartId}_title`);

            if (!chart || !symbolsContainer || !chartTitleEl) return;

            if (chart.symbols.length === 0) {
                symbolsContainer.innerHTML = '';
                chartTitleEl.textContent = `Chart ${chartId.split('_')[1] || chartIdCounter}`; // Reset title
                return;
            }
            
            chartTitleEl.textContent = chart.symbols.map(s => s.name || s.symbol).join(' vs ') || `Chart ${chartIdCounter}`;

            symbolsContainer.innerHTML = chart.symbols.map((s, index) => `
                <span class="chart-symbol-tag">
                    <span class="symbol-color-dot" style="background-color: ${colorPalette[index % colorPalette.length]}"></span>
                    ${s.symbol}
                    <span class="remove-symbol" onclick="removeSymbolFromChart(event, '${chartId}', '${s.symbol}')">×</span>
                </span>
            `).join('');
        }
        
        function removeSymbolFromChart(event, chartId, symbol) {
            event.stopPropagation(); // Prevent click on parent elements
            const chart = charts[chartId];
            if (!chart) return;

            chart.symbols = chart.symbols.filter(s => s.symbol !== symbol);
            delete chart.data[symbol];

            updateChartRender(chartId);
            updateChartSymbols(chartId);
            showTemporaryMessage(`Removed ${symbol} from chart`, 'info');
        }

        function changeTimeframe(event, chartId, timeframe) {
            event.stopPropagation();
            const chart = charts[chartId];
            if (!chart) return;
            chart.timeframe = timeframe;

            // Update active button style
            const timeframeButtons = event.target.parentElement.querySelectorAll('.timeframe-btn');
            timeframeButtons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Refetch or re-filter data based on new timeframe
            // For mock data, we might just re-render or simulate.
            // In a real app, this would trigger an API call or data slicing.
            console.log(`Chart ${chartId} timeframe changed to ${timeframe}. Re-fetching/filtering data...`);
            // For now, just re-render with existing mock data (which is always 1 year)
            updateChartRender(chartId); 
            showTemporaryMessage(`Timeframe for chart ${chartId} set to ${timeframe}`, 'info');
        }

        function toggleChartDisplay(event, chartId, displayMode) {
            event.stopPropagation();
            const chart = charts[chartId];
            if (!chart) return;
            chart.displayMode = displayMode;

            const displayToggles = event.target.parentElement.querySelectorAll('.display-toggle');
            displayToggles.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            updateChartRender(chartId);
            showTemporaryMessage(`Display mode for chart ${chartId} set to ${displayMode}`, 'info');
        }


        function showTemporaryMessage(message, type = 'info') { // types: info, success, error
            const popup = document.createElement('div');
            popup.className = `message-popup ${type}`;
            popup.textContent = message;
            document.body.appendChild(popup);
            setTimeout(() => {
                popup.remove();
            }, 4000); // Matches animation duration
        }
        
        function toggleTickerType(type) {
            const button = document.querySelector(`.filter-toggle[data-type="${type}"]`);
            button.classList.toggle('active');
            // Add logic to filter search based on active types
            console.log(`Toggled ticker type: ${type}, Active: ${button.classList.contains('active')}`);
        }

        function toggleDataSource(source) {
            const button = document.querySelector(`.filter-toggle[data-source="${source}"]`);
            button.classList.toggle('active');
            // Add logic to filter search based on active sources
            console.log(`Toggled data source: ${source}, Active: ${button.classList.contains('active')}`);
        }
        
        function saveSettings() {
            const refreshInterval = document.getElementById('refreshInterval').value;
            const defaultTimeRange = document.getElementById('defaultTimeRange').value;
            console.log('Settings saved:', { refreshInterval, defaultTimeRange });
            showTemporaryMessage('Settings saved successfully!', 'success');
            // Implement actual saving logic (e.g., localStorage)
        }

        function refreshAllData() {
            console.log('Refreshing all data...');
            showTemporaryMessage('Refreshing all data...', 'info');
            // Implement data refresh logic for all components
            loadWatchlistData(); // Reload watchlist
            updateKeyMetrics(); // Reload key metrics
            // Potentially re-fetch data for all active charts
            Object.keys(charts).forEach(chartId => {
                if (charts[chartId].symbols.length > 0) {
                    // Simulate re-fetching data for each symbol in the chart
                    charts[chartId].symbols.forEach(s => {
                        // This is where you'd make an API call in a real app
                        // For now, let's just log it and potentially update mock data slightly
                        console.log(`Simulating data refresh for ${s.symbol} in chart ${chartId}`);
                        if (charts[chartId].data[s.symbol]) {
                             // Slightly alter mock data to show refresh
                            const currentValues = charts[chartId].data[s.symbol].values;
                            charts[chartId].data[s.symbol].values = currentValues.map(v => v + (Math.random()-0.5)*2);
                        }
                    });
                    updateChartRender(chartId);
                }
            });
             showTemporaryMessage('All data refreshed!', 'success');
        }

        // Mock function, replace with actual modal logic
        function showSearchModal() {
            showTemporaryMessage('Search modal would open here.', 'info');
            document.getElementById('searchBox').focus();
        }
        
        // Mock liquidity dashboard navigation
        function showLiquidityDashboard() {
            showTab('liquidity');
            showTemporaryMessage('Navigated to Liquidity Dashboard.', 'info');
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', init);
        // Hide search results when clicking outside
        document.addEventListener('click', function(event) {
            const searchContainer = document.querySelector('.search-container');
            const searchResultsEl = document.getElementById('searchResults');
            if (searchContainer && !searchContainer.contains(event.target)) {
                searchResultsEl.style.display = 'none';
            }
        });

    </script>
</body>
</html>
